"use strict";
// Copyright Datastax, Inc
// SPDX-License-Identifier: Apache-2.0
// noinspection ExceptionCaughtLocallyJS
Object.defineProperty(exports, "__esModule", { value: true });
exports.DevOpsAPIHttpClient = void 0;
const clients_1 = require("../../../lib/api/clients");
const errors_1 = require("../../../administration/errors");
const constants_1 = require("../../../lib/api/constants");
const utils_1 = require("../../../lib/utils");
class DevOpsAPIHttpClient extends clients_1.HttpClient {
    constructor(opts) {
        super(opts, [mkAuthHeaderProvider(opts.tokenProvider)], errors_1.DevOpsAPITimeoutError.mk);
    }
    async request(req, timeoutManager, started = 0) {
        const isLongRunning = started !== 0;
        try {
            const url = this.baseUrl + req.path;
            if (!isLongRunning) {
                this.logger.adminCommandStarted?.(req, isLongRunning, timeoutManager.initial());
            }
            started || (started = performance.now());
            const resp = await this._request({
                url: url,
                method: req.method,
                params: req.params,
                data: JSON.stringify(req.data),
                forceHttp1: true,
                timeoutManager,
            });
            const data = resp.body ? (0, utils_1.jsonTryParse)(resp.body, undefined) : undefined;
            if (resp.status >= 400) {
                throw new errors_1.DevOpsAPIResponseError(resp, data);
            }
            if (!isLongRunning) {
                this.logger.adminCommandSucceeded?.(req, false, data, started);
            }
            return {
                data: data,
                status: resp.status,
                headers: resp.headers,
            };
        }
        catch (e) {
            if (!(e instanceof Error)) {
                throw e;
            }
            this.logger.adminCommandFailed?.(req, isLongRunning, e, started);
            throw e;
        }
    }
    async requestLongRunning(req, info) {
        const isLongRunning = info.options?.blocking !== false;
        const timeoutManager = info.timeoutManager;
        this.logger.adminCommandStarted?.(req, isLongRunning, timeoutManager.initial());
        const started = performance.now();
        const resp = await this.request(req, timeoutManager, started);
        const id = (typeof info.id === 'function')
            ? info.id(resp)
            : info.id;
        await this._awaitStatus(id, req, info, started);
        this.logger.adminCommandSucceeded?.(req, isLongRunning, resp, started);
        return resp;
    }
    async _awaitStatus(id, req, info, started) {
        if (info.options?.blocking === false) {
            return;
        }
        const pollInterval = info.options?.pollInterval || info.defaultPollInterval;
        let waiting = false;
        for (let i = 1; i++;) {
            if (waiting) {
                continue;
            }
            waiting = true;
            this.logger.adminCommandPolling?.(req, started, pollInterval, i);
            const resp = await this.request({
                method: constants_1.HttpMethods.Get,
                path: `/databases/${id}`,
                methodName: req.methodName,
            }, info.timeoutManager, started);
            if (resp.data?.status === info.target) {
                break;
            }
            if (!info.legalStates.includes(resp.data?.status)) {
                const okStates = [info.target, ...info.legalStates];
                const error = new errors_1.DevOpsUnexpectedStateError(`Created database is not in any legal state [${okStates.join(',')}]`, okStates, resp.data);
                this.logger.adminCommandFailed?.(req, true, error, started);
                throw error;
            }
            await new Promise((resolve) => {
                setTimeout(() => {
                    waiting = false;
                    resolve();
                }, pollInterval);
            });
        }
    }
}
exports.DevOpsAPIHttpClient = DevOpsAPIHttpClient;
const mkAuthHeaderProvider = (tp) => (tp)
    ? () => {
        const token = tp.getToken();
        return (token instanceof Promise)
            ? token.then(mkAuthHeader)
            : mkAuthHeader(token);
    } : () => ({});
const mkAuthHeader = (token) => (token)
    ? { [constants_1.DEFAULT_DEVOPS_API_AUTH_HEADER]: `Bearer ${token}` }
    : {};
